% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fql.R
\name{fql}
\alias{fql}
\title{Fit a Flexible Quasi-Likelihood Model}
\usage{
fql(
  formula,
  data,
  init.method = c("nb", "zero"),
  var.method = c("auto", "spline", "kernel", "constant"),
  tol = 1e-05,
  max.iter = 100,
  verbose = FALSE
)
}
\arguments{
\item{formula}{An object of class \code{\link[stats]{formula}}: a symbolic
description of the model to be fitted. The response should be a
non-negative count variable.}

\item{data}{A data frame containing the variables in the model.}

\item{init.method}{Method for initializing beta coefficients. \code{"nb"}
(default) initializes from a negative binomial GLM fit via
\code{\link[MASS]{glm.nb}}. \code{"zero"} initializes all coefficients
to zero.}

\item{var.method}{Method for estimating the variance function V(mu).
\code{"auto"} (default) tries methods in order: spline, kernel (bw+1),
kernel (bw+3), constant, using the first that succeeds. \code{"spline"}
uses P-spline via \code{\link[mgcv]{gam}}. \code{"kernel"} uses Gaussian
kernel smoothing. \code{"constant"} sets V(mu) = 1 (equivalent to
Poisson-like working variance).}

\item{tol}{Convergence tolerance for the iterative algorithm. Default is
\code{1e-5}.}

\item{max.iter}{Maximum number of outer iterations (alternating between
variance estimation and beta estimation). Default is \code{100}.}

\item{verbose}{Logical. If \code{TRUE}, prints progress messages during
fitting. Default is \code{FALSE}.}
}
\value{
An object of class \code{"fql"}, which is a list containing:
  \describe{
    \item{coefficients}{Named vector of estimated regression coefficients.}
    \item{se}{Named vector of sandwich standard errors.}
    \item{p.value}{Named vector of Wald test p-values.}
    \item{vcov}{Sandwich variance-covariance matrix.}
    \item{fitted.values}{Estimated means (mu).}
    \item{residuals}{Response residuals (y - mu).}
    \item{variance}{Estimated variance function values V(mu_i).}
    \item{var.method.used}{Character string indicating which variance
      estimation method was used: \code{"spline"}, \code{"kernel"},
      or \code{"constant"}.}
    \item{linear.predictors}{Linear predictor values (eta = X beta).}
    \item{converged}{Logical indicating whether the algorithm converged.}
    \item{iterations}{Number of outer iterations performed.}
    \item{df.residual}{Residual degrees of freedom.}
    \item{n}{Number of observations.}
    \item{formula}{The model formula.}
    \item{call}{The matched call.}
    \item{link}{The link function used (currently always \code{"log"}).}
    \item{x}{The design matrix.}
    \item{y}{The response vector.}
  }
}
\description{
Fits a flexible quasi-likelihood (FQL) generalized linear model for count
data with heteroscedastic variance. The variance is modeled as an unknown
smooth function of the mean, estimated nonparametrically via P-splines or
kernel smoothing. This avoids distributional assumptions while properly
accounting for overdispersion.
}
\details{
The FQL model assumes:
\deqn{\log(\mu_i) = X_i^T \beta}
\deqn{Var(Y_i) = V(\mu_i)}
where \eqn{V(\cdot)} is an unknown smooth function estimated nonparametrically.

The estimation alternates between:
\enumerate{
  \item Estimating \eqn{V(\mu)} by fitting a P-spline (or kernel smoother)
    to the squared residuals as a function of \eqn{\mu}.
  \item Re-estimating \eqn{\beta} via IRLS with the estimated variance weights.
}

Inference uses a sandwich covariance estimator that is robust to
misspecification of the variance function.

When \code{var.method = "auto"}, the function tries variance estimation
methods in the following order, using the first that succeeds:
\enumerate{
  \item P-spline via \code{mgcv::gam()}
  \item Kernel smoother with bandwidth \code{bw + 1}
  \item Kernel smoother with bandwidth \code{bw + 3}
  \item Constant variance (V = 1)
}
This fallback strategy handles numerical difficulties that can arise with
sparse or extreme data.
}
\examples{
# Fit FQL model to the quine dataset
data(quine, package = "MASS")
fit <- fql(Days ~ Eth + Sex + Age + Lrn, data = quine)
summary(fit)

# Compare with negative binomial GLM
nb_fit <- MASS::glm.nb(Days ~ Eth + Sex + Age + Lrn, data = quine)
cbind(FQL = coef(fit), NB = coef(nb_fit))

# Predictions
head(predict(fit, type = "response"))

# Confidence intervals
confint(fit)

}
\references{
Shi, Y., Li, H., Wang, C., Chen, J., Jiang, H., Shih, Y.-C. T.,
Zhang, H., Song, Y., Feng, Y., & Liu, L. (2023).
A flexible quasi-likelihood model for microbiome abundance count data.
\emph{Statistics in Medicine}, 42(25), 4632--4643.
\doi{10.1002/sim.9880}
}
\seealso{
\code{\link{summary.fql}}, \code{\link{predict.fql}},
  \code{\link{plot.fql}}, \code{\link{fql_multi}}
}
