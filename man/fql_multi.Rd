% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fql-multi.R
\name{fql_multi}
\alias{fql_multi}
\title{Fit FQL Models Across Multiple Taxa}
\usage{
fql_multi(
  otu_table,
  formula,
  data,
  p.adjust.method = "BH",
  prevalence.filter = 0.25,
  verbose = TRUE,
  ...
)
}
\arguments{
\item{otu_table}{A matrix or data frame of abundance counts, where rows
are samples and columns are taxa (OTUs). Column names will be used as
taxon identifiers in the output.}

\item{formula}{A one-sided formula specifying the covariates (without the
response), e.g., \code{~ group + age + offset(log_total)}. The response
is automatically set to each column of \code{otu_table}.}

\item{data}{A data frame containing the covariates referenced in
\code{formula}. Must have the same number of rows as \code{otu_table}.}

\item{p.adjust.method}{Method for p-value adjustment. Any method accepted
by \code{\link[stats]{p.adjust}} can be used. Default is \code{"BH"}
(Benjamini-Hochberg for FDR control).}

\item{prevalence.filter}{Minimum prevalence threshold (proportion of
non-zero samples). Taxa with prevalence below this value are excluded.
Default is 0.25 (25\%).}

\item{verbose}{Logical. If \code{TRUE}, prints progress. Default is \code{TRUE}.}

\item{...}{Additional arguments passed to \code{\link{fql}}.}
}
\value{
A data frame with one row per taxon and columns:
  \describe{
    \item{taxon}{Taxon name (from column names of otu_table).}
    \item{prevalence}{Proportion of non-zero samples.}
    \item{mean_abundance}{Mean abundance across all samples.}
    \item{covariate}{Name of each covariate (one row per taxon-covariate
      combination, excluding intercept).}
    \item{estimate}{Estimated coefficient.}
    \item{se}{Standard error.}
    \item{z_value}{Wald z-statistic.}
    \item{p_value}{Raw p-value.}
    \item{p_adjusted}{Adjusted p-value.}
    \item{var_method}{Variance estimation method used.}
    \item{converged}{Whether the model converged.}
  }
  The data frame is sorted by adjusted p-value.
}
\description{
Applies the FQL model to each column (taxon) of an OTU/abundance count
table, then adjusts p-values for multiple testing. This implements the
analysis workflow described in Section 4 of Shi et al. (2023).
}
\details{
For each taxon, the function constructs a two-sided formula with the
taxon count as the response and the covariates from \code{formula},
then calls \code{\link{fql}} to fit the model. Taxa failing to converge
or producing errors are reported with \code{NA} values.

The prevalence filter removes taxa with too many zeros before fitting,
as extremely sparse taxa may not yield meaningful results with
one-part models (see Discussion in Shi et al., 2023).
}
\examples{
\donttest{
# Simulate a small OTU table
set.seed(42)
n <- 100
otu <- matrix(rnbinom(n * 5, mu = 10, size = 2), nrow = n)
colnames(otu) <- paste0("OTU", 1:5)
covariates <- data.frame(group = factor(rep(c("A", "B"), each = n/2)))

results <- fql_multi(otu, ~ group, data = covariates,
                     prevalence.filter = 0)
print(results)
}

}
\references{
Shi, Y., Li, H., Wang, C., Chen, J., Jiang, H., Shih, Y.-C. T.,
Zhang, H., Song, Y., Feng, Y., & Liu, L. (2023).
A flexible quasi-likelihood model for microbiome abundance count data.
\emph{Statistics in Medicine}, 42(25), 4632--4643.
\doi{10.1002/sim.9880}
}
\seealso{
\code{\link{fql}}, \code{\link[stats]{p.adjust}}
}
